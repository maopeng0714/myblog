+++
title = "一步一步在CentOS虚拟机上部署K8S集群"
date = "2019-10-04"
author = "Peng Mao"
description = "详细讲解怎么在自己的电脑上搭建起一套K8S集群"
+++


#### 安装配置虚拟机

- 下载Virtual Box 和 CentOS 镜像。
- 下载CentOS 7任意镜像版本，注意不要下载CentOS 8，有兼容性问题。
- 软件包选择Infrustructure Server, 虽然不带图形界面节省空间但是也带有必要的组件。
- 配置yum源

    ``` bash
    wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
    yum makecache
    yum update
    ```

- 关闭、禁用防火墙：

    ```bash
    systemctl stop firewalld
    systemctl disable firewalld
    ```

- 禁用SELINUX：
  只有执行这一操作之后，容器才能访问宿主的文件系统，进而能够正常使用 Pod 网络。您必须这么做，直到 kubelet 做出升级支持 SELinux 为止

   ```bash
   setenforce 0
   ```

- iptables 设置
  一些 RHEL/CentOS 7 的用户曾经遇到过：由于 iptables 被绕过导致网络请求被错误的路由。您得保证 在您的 sysctl 配置中 net.bridge.bridge-nf-call-iptables 被设为1。

    ```bash
    cat <<EOF >  /etc/sysctl.d/k8s.conf
    net.bridge.bridge-nf-call-ip6tables = 1
    net.bridge.bridge-nf-call-iptables = 1
    EOF

    lsmod | grep br_netfilter
    modprobe br_netfilter
    sysctl --system
    ```

- 关闭Swap

  ```bash
   - swapoff -a可临时关闭，但系统重启后恢复
   - 编辑/etc/fstab，注释掉包含swap的那一行即可，重启后可永久关闭，如下所示：
  ```

- 设置主机名

    ```bash
    - hostname kube-master 临时改变
    - 编辑/etc/hosts 文件
    - 编辑 /etc/sysconfig/network 加入hostname
    ```

#### 设置虚拟机网络

一般情况下，虚拟机的网络模式有两种选择，NAT或者上Bridge，在NAT模式下，虚拟机从属于主机，也就是访问外部网络必须通过主机来访问，因此虚拟机的IP只有主机才能识别。而Bridge桥接模式下，虚拟机和主机是平行关系，共享一张网卡（使用网卡的多个接口），可以直接访问外部网络。
因此如果要想从主机上直接访问虚拟机的服务，需要用桥接模式而非NAT模式。但是桥接模式的IP一般会变动，为了避免每次远程连接都要重新设置IP，这里设置成静态IP。

- 在VirtualBox中设置为桥接网络
- 查看主机的IP信息，获取Gateway，DNS，NetMask等信息

    ```bash
     以太网适配器 vEthernet (外网虚拟交换机):
     连接特定的 DNS 后缀 . . . . . . . :
     本地链接 IPv6 地址. . . . . . . . : fe80::5ce1:b6fb:59b8:245b%16
     IPv4 地址 . . . . . . . . . . . . : 192.168.31.235
     子网掩码  . . . . . . . . . . . . : 255.255.255.0
     默认网关. . . . . . . . . . . . . : 192.168.31.1
    ```

- 编辑 /etc/sysconfig/network文件（主机名、默认网关、DNS）

    ```bash
      # Created by anaconda
        NETWORKING=yes
        GATEWAY=192.168.31.1
        DNS1=192.168.31.1
        DNS1=8.8.8.8
        DNS2=8.8.4.4
        HOSTNAME=kube-master
    ```

- 编辑 /etc/sysconfig/network-scripts/ifcfg-enp0s3（配置ip地址、网关、DNS）

    ```bash
        TYPE="Ethernet"
        PROXY_METHOD=none
        BROWSER_ONLY=no
        NM_CONTROLLED=no    //不收NetworkManager控制
        BOOTPROTO="static"  //手动设定IP
        DEFROUTE="yes"
        IPV4_FAILURE_FATAL="no"
        IPV6INIT="yes"
        IPV6_AUTOCONF="yes"
        IPV6_DEFROUTE="yes"
        IPV6_FAILURE_FATAL="no"
        NAME="enp0s3"             //网卡名字，跟文件名匹配
        UUID="7d367b57-a1da-462b-b26c-9e130ff83a63"
        DEVICE="enp0s3"
        ONBOOT="yes"             //启动时就启用网络
        IPADDR="192.168.31.91"   //固定IP
        GATEWAY="192.168.31.1"   //网关地址
        NETMASK="255.255.255.0"   //掩码
    ```

- 编辑 /etc/resolve.conf文件(配置DNS解析)

    ```bash
        # Generated by NetworkManager
        nameserver 192.168.31.1  //DNS地址
        nameserver 8.8.8.8
        nameserver 8.8.4.4
    ```

- 重启网络服务

``` bash
     systemctl restart network
```

#### 安装Docker

 注意安装k8s支持的版本，不要太高

- 安装必要的一些系统工具

```bash
sudo yum install -y yum-utils device-mapper-persistent-data lvm2
```

- 添加软件源信息

```bash
sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
```

- 更新并安装 Docker-CE

```bash
sudo yum makecache fast
yum list docker-ce.x86_64  --showduplicates |sort -r
yum install -y --setopt=obsoletes=0 docker-ce-18.09.8-3.el7
```

- 开启Docker服务

```bash
# Setup daemon.
cat > /etc/docker/daemon.json <<EOF
{
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  },
  "storage-driver": "overlay2",
  "storage-opts": [
    "overlay2.override_kernel_check=true"
  ]
}
EOF
sudo service docker start
```

- 设置开机启动

```bash
sudo systemctl enable docker
```

如果报错说docker版本太高，卸载docker，选择合适的版本重装：

``` bash
yum -y remove docker-ce.x86_64
yum -y remove docker-ce-cli.x86_64
yum -y remove containerd.io.x86_64
rm -rf /var/lib/docker
yum list docker-ce.x86_64  --showduplicates |sort -r
yum install -y --setopt=obsoletes=0 docker-ce-18.09.8-3.el7
systemctl start docker
systemctl enable docker
```

#### 安装kubelet，kubeadm，kubectl

```bash
#配置kubernetes.repo为阿里云
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg  http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

yum install -y kubeadm-1.14.7-0 kubectl-1.14.7-0  kubelet-1.14.7-0  --setopt=obsoletes=0 --disableexcludes=kubernetes
systemctl enable --now kubelet.service
```

#### 配置kubelet

确保docker 的cgroup driver 和kubelet的cgroup driver一样：

```bash
docker info | grep -i cgroup

vim /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf

vim /var/lib/kubelet/config.yaml

vim /var/lib/kubelet/kubeadm-flags.env
KUBELET_KUBEADM_ARGS="--cgroup-driver=systemd --network-plugin=cni --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1"

更新为 cgroupDriver: systemd

vim /etc/sysconfig/kubelet
KUBELET_EXTRA_ARGS= --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice

systemctl daemon-reload
systemctl restart kubelet
```

#### 复制虚拟机

将Master虚拟机复制两份，一个修改hostname 为kube-node1, 另一个为kube-node2.
修改上面指定的的固定IP地址，防止冲突。

#### 创建主节点Master

- 选项--pod-network-cidr=192.168.0.0/16表示集群将使用Calico网络，这里需要提前指定Calico的子网范围
- 选项--apiserver-advertise-address表示绑定的网卡IP，这里一定要绑定前面提到的enp0s8网卡，否则会默认使用enp0s3网卡
- 选项--image-repository，指定一个可用的仓库
- 选项--kubernetes-version=v1.10.0指定K8S版本

```bash
kubeadm init --pod-network-cidr=192.168.0.0/16 --apiserver-advertise-address=192.168.31.91 --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers --kubernetes-version=v1.14.7
```

若执行kubeadm init出错或强制终止，则再需要执行该命令时，需要先执行kubeadm reset重置。

保存配置，切换为普通用户但不要切换目录并执行：

```bash
 mkdir -p $HOME/.kube
 sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
 sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

#### 创建网络

如果不创建网络，查看pod状态时，可以看到kube-dns组件是阻塞状态，集群时不可用的：

```bash
// 使用Calico
kubectl apply -f https://docs.projectcalico.org/v3.8/manifests/calico.yaml

//修改或更新ＡＰＩｓｅｒｖｅｒ配置
vim /etc/kubernetes/manifests/kube-apiserver.yaml
//将Master作为工作节点
kubectl taint nodes --all node-role.kubernetes.io/master-
```

#### 将其他节点加入集群

- 使用 kubeadm init 时返回的信息加入集群

```bash
//token２４ｈ　有效
kubeadm join 192.168.31.91:6443 --token 41aso1.p548va8rsw0pllbh \
    --discovery-token-ca-cert-hash sha256:085c73c1bcb5be1fc9c4d399c7aeaa105266e9f1510a62d36d783b349793ec8c
```

- 重新生成 token 并加入

```bash
kubeadm token generate
kubeadm token create <generated-token> --print-join-command --ttl=24h
```

- 查看所有pod状态
 运行kubectl get pods -n kube-system，将主节点（master节点）中的【/etc/kubernetes/admin.conf】文件拷贝到从节点相同目录下:

 ```bash
 scp -r /etc/kubernetes/admin.conf ${node1}:/etc/kubernetes/admin.conf
 echo 'export KUBECONFIG=/etc/kubernetes/admin.conf' >> ~/.bash_profile
 source ~/.bash_profile
```

#### 集群重置

- 下线工作节点

```bash
kubectl drain <node name> --delete-local-data --force --ignore-daemonsets
kubectl delete node <node name>
```

- 重置工作节点

```bash
kubeadm reset
iptables -F && iptables -t nat -F && iptables -t mangle -F && iptables -X
```
